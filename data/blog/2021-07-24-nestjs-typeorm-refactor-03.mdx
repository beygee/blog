---
title: 'Nest.js TypeORM ë¦¬íŒ©í„°ë§ (SingleTableInheritance)'
date: '2021-07-24'
tags: ['nest.js', 'typeorm', 'refactoring', 'ddd']
draft: false
---

![](https://velog.velcdn.com/images/loakick/post/404e5730-0cc7-46be-9851-e6649a487a30/Nestjs.png)

## Overview

ì´ì „ì— TypeORMì—ì„œ ìì£¼ ì´ìš©í•˜ëŠ” QueryBuilderë¥¼ ë¦¬íŒ©í„°ë§í•˜ëŠ” ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” TypeORMì—ì„œ ë‹¨ì¼ í…Œì´ë¸” ìƒì† íŒ¨í„´ì„ ì´ìš©í•˜ëŠ” ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì—ì„œ ê°ì²´ì˜ ì±…ì„ì„ ì ì ˆí•˜ê²Œ ë¶„ë°°í•˜ê¸° ìœ„í•´ì„œ ìƒì†, í•©ì„±, ë‹¤í˜•ì„± ë‹¤ì–‘í•œ ê¸°ë²•ì„ ì´ìš©í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ìƒì†ë°›ì€ ê°ì²´ êµ¬ì¡°ë¥¼ ì–´ë–»ê²Œ DBì— ì €ì¥í•˜ì—¬ ì˜ì†ì„±ì„ ë³´ì¥í•  ìˆ˜ ìˆì„ê¹Œìš”?

í†µìƒì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” MySQL ê°™ì€ ê´€ê³„í˜• DBëŠ” ìƒì†ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í…Œì´ë¸”ì— ëŒ€ì‘ë˜ëŠ” Entity, ì¦‰ ê°ì²´ë¥¼ ê´€ê³„í˜• DBì— ì–´ë–¤ì‹ìœ¼ë¡œ ë§¤í•‘í•´ì•¼í•  ì§€ë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ ì¤‘ í•˜ë‚˜ê°€ ë‹¨ì¼ í…Œì´ë¸” ìƒì† íŒ¨í„´ì¸ë°, ìƒì† êµ¬ì¡°ì˜ ëª¨ë“  í´ë˜ìŠ¤ë“¤ì˜ í•„ë“œë¥¼ ë‹¨ì¼ í…Œì´ë¸” ì»¬ëŸ¼ì— ë§¤í•‘í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

![](https://miro.medium.com/max/1210/1*sG_aC5wB85eGrgmAuKiGPQ.png)

> ì¢Œì¸¡ì´ ê°ì²´ êµ¬ì¡°, ìš°ì¸¡ì´ ë§¤í•‘ë˜ëŠ” í…Œì´ë¸” â€œPatterns of Enterprise Application Architectureâ€ By Martinfowler

---

## TypeORM Single Table Pattern

TypeORMì—ì„œëŠ” `@TableInheritance` ì™€ `@ChildEntity` ë°ì½”ë ˆì´í„°ë¡œ ì‹±ê¸€ í…Œì´ë¸” íŒ¨í„´ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ ì´ë¯¸ì§€ ì²˜ëŸ¼ `Player`ë¥¼ ì˜ˆì‹œë¡œ ì½”ë“œë¥¼ êµ¬í˜„í•´ë³´ê² ìŠµë‹ˆë‹¤.

```typescript
// player.entity.ts
import { Column, Entity, PrimaryGeneratedColumn, TableInheritance, ChildEntity } from 'typeorm'

export enum PlayerType {
  FOOTBALL = 'FOOTBALL',
  CRICKET = 'CRICKET',
}

@Entity({ name: 'Player' })
@TableInheritance({ column: { type: 'enum', enum: PlayerType, name: 'type' } })
export class Player {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  name: string

  @Column({ enum: PlayerType, type: 'enum' })
  type: PlayerType

  public play() {
    console.log(`Player [${this.name}]: Play!!`)
  }
}

@ChildEntity(PlayerType.FOOTBALL)
export class Footballer extends Player {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  club: string

  // ì˜¤ë²„ë¼ì´ë”©
  public play() {
    console.log(`Footballer [${this.name}]: Play!!`)
  }
}

@ChildEntity(PlayerType.CRICKET)
export class Cricketer extends Player {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  batting: string

  // ì˜¤ë²„ë¼ì´ë”©
  public play() {
    console.log(`Cricketer [${this.name}]: Play!!`)
  }
}
```

ë¶€ëª¨ í´ë˜ìŠ¤ `Player`ì—ì„œ `@TableInheritance` ë°ì½”ë ˆì´í„°ì—ì„œ `type` ì»¬ëŸ¼ì„ ê°€ì§€ê³  ìì‹í´ë˜ìŠ¤ë¥¼ ë¶„ë¥˜í•˜ê² ë‹¤ê³  ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://miro.medium.com/max/596/1*5bb6py71-jfRHFWuYGLL0w.png)

ìœ„ ì½”ë“œë¥¼ í† ëŒ€ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í†µí•˜ì—¬ ìƒì„±ëœ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆì…ë‹ˆë‹¤.

ìš°ë¦¬ê°€ í™•ì¸í•´ì•¼ í•  ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. PlayerRepositoryë¡œ ì´ Playerë“¤ì„ ë¶ˆëŸ¬ì˜¤ë©´ ê°ê° íƒ€ì…ì— ë§ëŠ” ìì‹í´ë˜ìŠ¤ë¡œ ë§¤í•‘ì´ ë˜ëŠ”ê°€?

2. ê°ê°ì˜ ìì‹í´ë˜ìŠ¤ì—ì„œ play í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ë‹¤í˜•ì„±ì´ ì ìš©ë˜ì–´ ì˜¤ë²„ë¼ì´ë”©ëœ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ”ê°€?

ì´ ê°€ì„¤ë“¤ì„ í…ŒìŠ¤íŠ¸í•´ë³´ê¸° ìœ„í•´ ë¨¼ì € ê°„ë‹¨í•œ ë”ë¯¸ ë°ì´í„°ë¥¼ ë„£ì–´ë³´ê² ìŠµë‹ˆë‹¤.

![](https://miro.medium.com/max/552/1*uskSeSKEJttbJZz-3CGVxw.png)

### íƒ€ì…ì— ë§ëŠ” ìì‹í´ë˜ìŠ¤ë¡œ ë§¤í•‘ì´ ë˜ëŠ”ê°€?

`PlayerService`ë¥¼ ë§Œë“¤ì–´ ë¡œê·¸ë¥¼ ì°ì–´ í™•ì¸í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```typescript
// player.service.ts
import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { Repository } from 'typeorm'
import { Player } from './player.entity'

@Injectable()
export class PlayerService {
  constructor(
    @InjectRepository(Player)
    private readonly playerRepository: Repository<Player>
  ) {}

  public async findPlayers() {
    const players = await this.playerRepository.find()

    console.log(players)

    return players
  }
}
```

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![](https://miro.medium.com/max/566/1*8voqpZuZ4KUYP_iSEcqNRQ.png)

> íƒ€ì…ì— ë§ëŠ” ìì‹í´ë˜ìŠ¤ë¡œ ë§¤í•‘ë˜ì–´ ë‚´ë ¤ì˜µë‹ˆë‹¤!

ë¶€ëª¨í´ë˜ìŠ¤ì¸ PlayerRepositoryì—ì„œ ìì‹í´ë˜ìŠ¤ë¡œ ìë™ìœ¼ë¡œ ë§¤í•‘ë˜ì–´ ë‚´ë ¤ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë‹¤í˜•ì„±ì´ ì ìš©ë˜ì–´ ì˜¤ë²„ë¼ì´ë”© ëœ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ”ê°€?

ì´ë²ˆì—ë„ PlayerServiceì—ì„œ ë¡œê·¸ë¥¼ ì°ì–´ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

```typescript
// player.service.ts
import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { Repository } from 'typeorm'
import { Player } from './player.entity'

@Injectable()
export class PlayerService {
  constructor(
    @InjectRepository(Player)
    private readonly playerRepository: Repository<Player>
  ) {}

  public async findPlayers() {
    const players = await this.playerRepository.find()

    players.forEach((player) => player.play())

    return players
  }
}
```

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![](https://miro.medium.com/max/682/1*ZXef_uwHwquRmG9cwXVNHQ.png)

ì´ ì—­ì‹œë„ ìì‹í´ë˜ìŠ¤ì—ì„œ ì •ì˜í•œ play í•¨ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë”©ë˜ì–´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë§ˆë¬´ë¦¬

ì´ë¡œì¨ ë°ì´í„°ì˜ ì˜ì†ì„±ì„ ë³´ì¥í•œ ì±„ë¡œ ê°ì²´ì§€í–¥ì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ í™œìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì¸í”„ë¼ì— êµ¬ì• ë°›ì§€ ì•Šê³  ì½”ë“œì˜ í’ˆì§ˆì„ ëŒì–´ì˜¬ë ¤ì£¼ëŠ” TypeORMì˜ ê¸°ëŠ¥ì— ë‹¤ì‹œ í•œ ë²ˆ ë†€ëìŠµë‹ˆë‹¤.

Nest.js + TypeORM ë¦¬íŒ©í„°ë§ ì‹œë¦¬ì¦ˆëŠ” ì´ë ‡ê²Œ 3í¸ìœ¼ë¡œ ë§ˆë¬´ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤. ì“°ê³ ë‚˜ë‹ˆ Nest.jsì— ëŒ€í•œ ë‚´ìš©ì€ ê±°ì˜ ì—†ê³  TypeORM ë¦¬íŒ©í„°ë§ë§Œ í•œ ê²ƒ ê°™ì•„ì„œ ë¨¸ì“±í•˜ê¸´ í•˜ë„¤ìš”ğŸ˜…

í˜¹ì‹œë‚˜ í”¼ë“œë°±ì´ë‚˜ ë” ì¢‹ì€ ê°œì„  ì‚¬í•­ ê³µìœ ëŠ” ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤!

ë‹¤ìŒ í¬ìŠ¤íŒ…ì€ ì•±ì´ë‚˜, í”„ë¡ íŠ¸ êµ¬ì¡°, í˜¹ì€ ì¸í”„ë¼ìª½ ê´€ë ¨ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.
