---
title: 'Nest.js TypeORM ë¦¬íŒ©í„°ë§ (DDD Aggregate)'
date: '2021-07-24'
tags: ['nest.js', 'typeorm', 'refactoring', 'ddd']
draft: false
---

![](https://velog.velcdn.com/images/loakick/post/404e5730-0cc7-46be-9851-e6649a487a30/Nestjs.png)

## Overview

íšŒì‚¬ì—ì„œ ë°±ì—”ë“œì—ì„œ Nest.jsì™€ TypeORMë¥¼ ì• ìš©í•˜ëŠ” í¸ì…ë‹ˆë‹¤. ë‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª¨ë‘ ë…ìŠ¤ì˜ ì™„ì„±ë„ê°€ í›Œë¥­í•œ í¸ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‹¤ë¬´ì— ì ìš©í•˜ë©´ì„œ ì—¬ëŸ¬ ë‚œê´€ì— ë¶€ë”ªíˆê²Œ ë˜ë”êµ°ìš”. ğŸ˜ƒ `Repository`ì™€ `Service`ì˜ ê²½ê³„ë¥¼ ë¶„ë¦¬ë¥¼ í•˜ê³ , ë¦¬íŒ©í„°ë§í•˜ì—¬ ì¬ì‚¬ìš©ì„±ì„ ë†’ì˜€ë˜ ë°©ë²•ì„ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.

## Aggregate (ì§‘í•©ì²´)

AggregateëŠ” ë°ì´í„° ë³€ê²½ì˜ ë‹¨ìœ„ë¡œ ë‹¤ë£¨ëŠ” ì—°ê´€ ê°ì²´ì˜ ë¬¶ìŒì´ë¼ê³  í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ìš°ë¦¬ê°€ ìƒê°í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë„ë©”ì¸ì˜ ë‹¨ìœ„ê°€ ë©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, User ê°ì²´ì™€, UserAuth (ìœ ì € ê¶Œí•œ), UserProfile (ìœ ì € í”„ë¡œí•„)ê°ì²´ë¥¼ í†µí‹€ì–´ í•˜ë‚˜ì˜ Aggregateë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://miro.medium.com/max/796/1*Mj9nnEyxifzPlaSYHFwkNA.png)

UserAuthì™€ UserProfileì€ Userì— ì¢…ì†ì ì´ê¸° ë•Œë¬¸ì— UserAuthë‚˜ UserProfileì€ ë”°ë¡œ ì‚­ì œë˜ì–´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤.

í•˜ì§€ë§Œ Nest.jsì™€ TypeORMì„ ì—°ê²°í•´ ì“°ë‹¤ë³´ë©´ Serviceì—ì„œ ê°ê° ì—”í‹°í‹° Repoì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ë‹¤ìŒê³¼ ê°™ì´ UserAuthë§Œ ì§€ì›Œì§ˆ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.

```typescript
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
    @InjectRepository(UserAuth)
    private readonly userAuthRepository: Repository<UserAuth>,
    @InjectRepository(UserProfile)
    private readonly userProfileRepository: Repository<UserProfile>
  ) {}

  public async deleteUserAuth(userAuthId: number) {
    await this.userAuthRepository.delete(userAuthId)
  }
}
```

ë”°ë¼ì„œ Aggregateë‹¹ í•˜ë‚˜ì˜ Repositoryë¥¼ ë§Œë“¤ì–´ ì§„ì…ì ì„ í•œ ê³³ìœ¼ë¡œ ëª¨ì•„ ê´€ë¦¬ë¥¼ í•˜ëŠ” ê²½ìš°ê°€ ì¼ë°˜ì ì…ë‹ˆë‹¤. ìœ„ì™€ ê°™ì€ ê²½ìš°ì—ì„œëŠ” UserRepository ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ê°ì²´ ì ‘ê·¼ì— ê´€í•œ ì„¤ê³„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

```typescript
import { AbstractRepository, EntityRepository } from 'typeorm'
import { User } from './user.entity'

export interface UserFindOneOptions {
  id?: number
}

@EntityRepository(User)
export class UserRepository extends AbstractRepository<User> {
  // userAuth, userProfile ì¡°íšŒë¥¼ ë§‰ê³ , userë¥¼ í†µí•´ì„œë§Œ ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.
  public async findOne({ id }: UserFindOneOptions = {}) {
    const qb = this.repository
      .createQueryBuilder('User')
      .leftJoinAndSelect('User.userAuth', 'userAuth')
      .leftJoinAndSelect('User.userProfile', 'userProfile')

    if (id) qb.andWhere('User.id = :id', { id })

    return qb.getOne()
  }

  public async delete(userId: number) {
    return this.repository.delete(userId)
  }
}
```

UserRepositoryë¥¼ ì»¤ìŠ¤í…€í•˜ì—¬ ì˜ë„ì¹˜ì•Šì€ ì ‘ê·¼ì„ ëª¨ë‘ ë§‰ì•˜ìŠµë‹ˆë‹¤. ì´ì œ userService ì—ì„œ ê°ê°ì˜ Entityì— ë”°ë¡œ Repoë¥¼ ì ‘ê·¼í•˜ì§€ ì•Šê³  Root ê°ì²´ì¸ Userì—ë§Œ ì ‘ê·¼í•˜ì—¬ ë‚˜ë¨¸ì§€ í•˜ìœ„ ê°ì²´ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
import { Injectable } from '@nestjs/common'
import { UserRepository } from './user.repository'

@Injectable()
export class UserService {
  constructor(private readonly userRepository: UserRepository) {}

  public async findByUserId(userId: number) {
    const user = await this.userRepository.findOne({ id: userId })
    // user.userAuth or user.userProfile ì ‘ê·¼ ê°€ëŠ¥!
    return user
  }

  public async delete(userId: number) {
    // DB Cascadeë¥¼ ê±¸ì–´ì£¼ì–´ userAuthì™€ userProfileê¹Œì§€ ì‚­ì œë˜ê²Œ í•œë‹¤.
    return this.userRepository.delete(userId)
  }
}
```

ì»¤ìŠ¤í…€ Repositoryë¥¼ ë§Œë“¤ì–´ ë‹¤ìŒê³¼ ê°™ì€ íš¨ìš©ì„ ëˆ„ë¦´ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

- Aggregateì˜ ê²½ê³„ì™€ Repositoryì˜ ì—­í•  ë²”ìœ„ë¥¼ ì¼ì¹˜ì‹œí‚´
- Repositoryì˜ ê°œìˆ˜ë¥¼ ì¤„ì„
- ë¶ˆí•„ìš”í•œ ë˜ëŠ” ìœ„í—˜í•œ ì ‘ê·¼ì„ ì°¨ë‹¨

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” TypeORM ì¿¼ë¦¬ ë¹Œë”ì˜ ì¬ì‚¬ìš©ì„±ì„ ë†’ì´ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
